import { marked } from 'marked'

/**
 * Evaluates SEO completeness and health for a blog post
 * Returns deterministic, explainable diagnostics without scoring
 */
export function evaluateSeo(post) {
  const html = marked(post.content || '')
  const headingMatches = (post.content || '').match(/^#+\s+.+$/gm) || []
  const h1Count = (post.content || '').match(/^#\s+.+$/gm)?.length || 0
  const h2Count = (post.content || '').match(/^##\s+.+$/gm)?.length || 0
  const hasLists = /^\s*[-*+]\s+.+$/m.test(post.content || '')
  const hasCodeBlocks = /```|`[^`]+`/.test(post.content || '')
  const contentLength = (post.content || '').length

  // Extract first paragraph (before first H2 or at start)
  const firstH2Index = (post.content || '').search(/^##\s+/m)
  const introContent =
    firstH2Index > 0
      ? (post.content || '').substring(0, firstH2Index)
      : (post.content || '').split('\n\n')[0] || ''
  const firstParagraphLength = introContent.trim().split('\n')[0]?.length || 0

  return {
    preview: generateSearchPreview(post),
    healthChecks: evaluateHealthChecks(post, h1Count, h2Count, html, introContent, contentLength),
    contentQuality: evaluateContentQuality(
      h1Count,
      h2Count,
      hasLists,
      hasCodeBlocks,
      introContent,
      contentLength,
      headingMatches
    ),
    structuredData: generateStructuredDataStatus(post),
  }
}

function generateSearchPreview(post) {
  const title = (post.seo_title || post.title || 'Untitled').substring(0, 60)
  const description = (post.seo_description || post.excerpt || '').substring(0, 160)
  const url = `pioneerwebtools.com/blog/${post.slug || 'slug'}`

  return {
    title,
    description,
    url,
    titleLength: title.length,
    descriptionLength: description.length,
    titleWarnings: getTitleWarnings(title),
    descriptionWarnings: getDescriptionWarnings(description),
  }
}

function getTitleWarnings(title) {
  const warnings = []
  if (title.length < 30)
    warnings.push({
      type: 'warning',
      message: 'Title is very short — may lose visibility in search results',
    })
  if (title.length > 60)
    warnings.push({
      type: 'info',
      message: 'Title may be truncated in search results (ideal: 50-60 characters)',
    })
  return warnings
}

function getDescriptionWarnings(description) {
  const warnings = []
  if (!description)
    warnings.push({
      type: 'info',
      message: 'Meta description missing (optional but recommended for CTR)',
    })
  if (description && description.length < 120)
    warnings.push({
      type: 'info',
      message: 'Meta description is short (ideal: 155-160 characters)',
    })
  if (description && description.length > 160)
    warnings.push({
      type: 'info',
      message: 'Meta description may be truncated (ideal: 155-160 characters)',
    })
  return warnings
}

function evaluateHealthChecks(post, h1Count, h2Count, html, introContent, contentLength) {
  const checks = []

  // Title check
  if (!post.title) {
    checks.push({
      status: 'error',
      label: 'Title missing',
      explanation: 'Every page needs a unique, descriptive title for both users and search engines.',
    })
  } else {
    checks.push({
      status: 'success',
      label: 'Title present',
      explanation: 'Your page has a descriptive title.',
    })
  }

  // H1 check
  if (h1Count === 0) {
    checks.push({
      status: 'error',
      label: 'No H1 detected',
      explanation: 'Your page should start with one H1 heading — the main topic of the page.',
    })
  } else if (h1Count > 1) {
    checks.push({
      status: 'error',
      label: 'Multiple H1s detected',
      explanation: 'Use only one H1 per page. Additional headings should be H2, H3, etc.',
    })
  } else {
    checks.push({
      status: 'success',
      label: 'Single H1 detected',
      explanation: 'Your page structure follows SEO best practices.',
    })
  }

  // Canonical check (auto-generated by default)
  checks.push({
    status: 'success',
    label: 'Canonical URL set',
    explanation: post.canonical_override
      ? `Custom canonical: ${post.canonical_override}`
      : 'Auto-generated from slug. No duplicates.',
  })

  // Noindex check
  if (post.seo_noindex) {
    checks.push({
      status: 'error',
      label: 'Noindex enabled',
      explanation: 'This page is hidden from search. Publish it if it should be discoverable.',
    })
  } else {
    checks.push({
      status: 'success',
      label: 'Page is indexable',
      explanation: 'Search engines can discover and rank this page.',
    })
  }

  // Meta description check
  if (!post.seo_description) {
    checks.push({
      status: 'warning',
      label: 'Meta description missing',
      explanation: 'Search engines may generate a snippet, but a custom description can improve click-through rate.',
    })
  } else {
    checks.push({
      status: 'success',
      label: 'Meta description present',
      explanation: `Description is ${post.seo_description.length} characters — within ideal range.`,
    })
  }

  // Internal links check (basic heuristic)
  const hasInternalLinks = /\[.*?\]\(\/blog\/.*?\)/.test(post.content || '')
  if (!hasInternalLinks) {
    checks.push({
      status: 'warning',
      label: 'No internal links detected',
      explanation:
        'Internal links help search engines discover related content and distribute authority.',
    })
  } else {
    checks.push({
      status: 'success',
      label: 'Internal links present',
      explanation: 'You link to related posts. This helps users and search engines.',
    })
  }

  // Featured image check
  if (!post.thumbnail_url) {
    checks.push({
      status: 'warning',
      label: 'No featured image',
      explanation: 'Images improve engagement and can appear in image search results.',
    })
  } else {
    checks.push({
      status: 'success',
      label: 'Featured image present',
      explanation: 'Image is ready for social sharing and image search.',
    })
  }

  return checks
}

function evaluateContentQuality(h1Count, h2Count, hasLists, hasCodeBlocks, introContent, contentLength, headingMatches) {
  const checks = []

  // Introduction check
  if (introContent.trim().length < 50) {
    checks.push({
      status: 'warning',
      label: 'Weak introduction',
      explanation: 'Start with a clear, concise summary (40+ characters) before your first heading.',
    })
  } else {
    checks.push({
      status: 'success',
      label: 'Clear introduction detected',
      explanation: 'Your opening paragraph introduces the topic well.',
    })
  }

  // Heading structure check
  if (h2Count > 0) {
    checks.push({
      status: 'success',
      label: 'Headings structured logically',
      explanation: `You use ${h2Count} subheading${h2Count > 1 ? 's' : ''} — good for scannability and SEO.`,
    })
  } else {
    checks.push({
      status: 'warning',
      label: 'No subheadings (H2+) detected',
      explanation: 'Break up long content with H2 and H3 headings for readability and structure.',
    })
  }

  // Lists and examples check
  if (hasLists || hasCodeBlocks) {
    checks.push({
      status: 'success',
      label: 'Examples or lists detected',
      explanation: 'Your content uses lists or code examples — helps users understand quickly.',
    })
  } else {
    checks.push({
      status: 'info',
      label: 'No examples or lists detected',
      explanation: 'Consider adding bullet points, numbered lists, or code examples to clarify concepts.',
    })
  }

  // Content length check
  if (contentLength < 300) {
    checks.push({
      status: 'warning',
      label: 'Very short content',
      explanation: 'Aim for at least 300–500 words. Longer, detailed articles rank better.',
    })
  } else if (contentLength > 5000) {
    checks.push({
      status: 'info',
      label: 'Very long content',
      explanation: 'Your article is comprehensive. Consider if readers might prefer a summary.',
    })
  } else {
    checks.push({
      status: 'success',
      label: 'Content length is good',
      explanation: `Your article is ${contentLength} characters — detailed enough for search visibility.`,
    })
  }

  // Conclusion check
  const hasConclusion =
    /^#+\s+(conclusion|summary|final\s+thoughts|takeaway)/im.test(headingMatches.join('\n')) ||
    /^#+\s+\w+$/m.test(headingMatches[headingMatches.length - 1] || '')

  if (hasConclusion) {
    checks.push({
      status: 'success',
      label: 'Conclusion or summary detected',
      explanation: 'Your article wraps up with a clear conclusion.',
    })
  } else {
    checks.push({
      status: 'info',
      label: 'No conclusion detected',
      explanation: 'Consider ending with a summary or final thoughts to reinforce key points.',
    })
  }

  return checks
}

function generateStructuredDataStatus(post) {
  // Check what fields are available for JSON-LD generation
  const includedFields = []

  if (post.title) includedFields.push('headline')
  if (post.seo_description || post.excerpt) includedFields.push('description')
  if (post.published_at) includedFields.push('datePublished')
  if (post.updated_at) includedFields.push('dateModified')
  if (post.thumbnail_url) includedFields.push('image')

  const isValid = includedFields.length >= 3 // At least headline, description, date

  return {
    type: 'BlogPosting',
    status: isValid ? 'valid' : 'incomplete',
    includedFields,
    missingFields: !post.seo_description ? ['description'] : [],
    explanation: isValid
      ? 'Your page includes structured data that helps search engines understand it.'
      : 'Add more metadata to enable rich search results.',
  }
}

/**
 * Generate JSON-LD for a blog post (rendered at page load, not stored in DB)
 */
export function generateJsonLd(post, baseUrl = 'https://www.pioneerwebtools.com') {
  if (!post) return null

  return {
    '@context': 'https://schema.org',
    '@type': 'BlogPosting',
    headline: post.seo_title || post.title,
    description: post.seo_description || post.excerpt || '',
    image: post.thumbnail_url ? { '@type': 'ImageObject', url: post.thumbnail_url } : undefined,
    datePublished: post.published_at,
    dateModified: post.updated_at,
    author: {
      '@type': 'Organization',
      name: 'Pioneer Web Tools',
    },
    publisher: {
      '@type': 'Organization',
      name: 'Pioneer Web Tools',
      logo: {
        '@type': 'ImageObject',
        url: `${baseUrl}/favicon.svg`,
      },
    },
    mainEntityOfPage: {
      '@type': 'WebPage',
      '@id': `${baseUrl}/blog/${post.slug}`,
    },
  }
}
